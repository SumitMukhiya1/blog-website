<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Blog Post - Readium</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Professional Color Scheme - Black & White Only */
        :root {
            --primary: #FFFFFF;
            --secondary: #000000;
            --light: #F8F9FA;
            --white: #FFFFFF;
            --gray-light: #E9ECEF;
            --gray-medium: #6C757D;
            --gray-dark: #495057;
            --text: #333333;
            --border: #E5E7EB;
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: 'Inter', 'Segoe UI', system-ui, sans-serif;
            background-color: var(--white);
            color: var(--secondary);
            line-height: 1.6;
            padding: 0;
            margin: 0;
        }

        /* Desktop Navigation */
        .desktop-nav {
            display: none;
            background: var(--white);
            box-shadow: var(--shadow);
            padding: 1rem 0;
            border-bottom: 1px solid var(--border);
        }

        .navbar-brand {
            font-weight: 700;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            color: var(--secondary) !important;
            text-decoration: none;
        }

        .navbar-brand i {
            color: var(--secondary);
            font-size: 1.5rem;
            margin-right: 0.5rem;
        }

        /* Fixed Back Button - Small and Clean */
        .fixed-back-button {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            text-decoration: none;
            color: var(--secondary);
            background: var(--white);
            border-radius: 50%;
            transition: all 0.3s ease;
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
        }

        .fixed-back-button:hover {
            background: rgba(0, 0, 0, 0.05);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .fixed-back-button i {
            font-size: 1rem;
        }

        /* Mobile Header */
        .mobile-header {
            display: flex;
            align-items: center;
            padding: 1rem;
            background: var(--white);
            border-bottom: 1px solid var(--border);
            box-shadow: var(--shadow);
        }

        .mobile-title {
            flex: 1;
            text-align: center;
            font-weight: 700;
            font-size: 1.2rem;
            color: var(--secondary);
            margin: 0;
        }

        /* Main Container with Mobile Padding */
        .main-container {
            max-width: 100%;
            margin: 0 auto;
            padding: 1rem;
            padding-top: 1.5rem; /* Added space for fixed back button */
        }

        /* Editor Header - Mobile Optimized */
        .editor-header {
            margin-bottom: 2rem;
            text-align: center;
        }

        .editor-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--secondary);
            margin-bottom: 0.5rem;
            line-height: 1.3;
        }

        .editor-subtitle {
            color: var(--gray-medium);
            font-size: 1rem;
            margin: 0 auto;
        }

        /* Form Elements - Mobile Friendly */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            font-weight: 600;
            color: var(--secondary);
            margin-bottom: 0.75rem;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .form-control {
            background: var(--white);
            border: 1px solid var(--border);
            color: var(--secondary);
            border-radius: 8px;
            padding: 1rem;
            font-size: 1rem;
            transition: all 0.3s ease;
            font-family: inherit;
            width: 100%;
        }

        .form-control:focus {
            background: var(--white);
            border-color: var(--secondary);
            color: var(--secondary);
            box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.05);
        }

        .form-control::placeholder {
            color: var(--gray-medium);
            opacity: 0.7;
        }

        /* Rich Text Editor - Mobile Optimized */
        .editor-wrapper {
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        .editor-toolbar {
            background: var(--light);
            border-bottom: 1px solid var(--border);
            padding: 0.75rem;
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            align-items: center;
            overflow-x: auto;
        }

        .toolbar-group {
            display: flex;
            gap: 0.25rem;
            align-items: center;
            flex-shrink: 0;
        }

        .toolbar-btn {
            background: var(--white);
            border: 1px solid var(--border);
            color: var(--secondary);
            border-radius: 6px;
            padding: 0.5rem 0.6rem;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 36px;
        }

        .toolbar-btn:hover {
            background: rgba(0, 0, 0, 0.05);
            border-color: var(--gray-medium);
        }

        .toolbar-btn.active {
            background: var(--secondary);
            color: var(--white);
            border-color: var(--secondary);
        }

        .toolbar-divider {
            width: 1px;
            height: 20px;
            background: var(--border);
            margin: 0 0.25rem;
        }

        .editor-content {
            min-height: 300px;
            padding: 1.5rem;
            font-size: 1rem;
            line-height: 1.6;
            outline: none;
            background: var(--white);
        }

        .editor-content:empty:before {
            content: attr(placeholder);
            color: var(--gray-medium);
            font-style: italic;
        }

        .editor-content h1 {
            font-size: 1.8rem;
            font-weight: 700;
            margin: 1.5rem 0 1rem;
        }

        .editor-content h2 {
            font-size: 1.5rem;
            font-weight: 600;
            margin: 1.2rem 0 0.8rem;
        }

        .editor-content h3 {
            font-size: 1.2rem;
            font-weight: 600;
            margin: 1rem 0 0.6rem;
        }

        .editor-content p {
            margin-bottom: 1rem;
        }

        .editor-content ul, .editor-content ol {
            margin-bottom: 1rem;
            padding-left: 1.5rem;
        }

        .editor-content blockquote {
            border-left: 4px solid var(--border);
            padding-left: 1rem;
            margin: 1rem 0;
            color: var(--gray-medium);
            font-style: italic;
        }

        .editor-content a {
            color: var(--secondary);
            text-decoration: underline;
            font-weight: 500;
        }

        /* Featured Image Section - Mobile Optimized */
        .featured-image-section {
            margin-bottom: 1.5rem;
        }

        .image-upload-card {
            background: var(--white);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1rem;
            transition: all 0.3s ease;
            box-shadow: var(--shadow);
            text-align: center;
        }

        .image-upload-header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.8rem;
            margin-bottom: 1rem;
        }

        .image-upload-icon {
            font-size: 1.1rem;
            color: var(--gray-medium);
        }

        .image-upload-title {
            font-weight: 600;
            margin: 0;
            font-size: 1rem;
            color: var(--secondary);
        }

        .image-upload-container {
            border: 2px dashed var(--border);
            border-radius: 8px;
            padding: 2rem 1rem;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            margin-bottom: 1rem;
            background: var(--light);
        }

        .image-upload-container:hover {
            border-color: var(--gray-medium);
            background: rgba(0, 0, 0, 0.02);
        }

        .image-upload-main-icon {
            font-size: 2rem;
            color: var(--gray-medium);
            margin-bottom: 0.8rem;
        }

        .image-upload-text {
            color: var(--secondary);
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .image-upload-hint {
            font-size: 0.8rem;
            color: var(--gray-medium);
        }

        .image-preview {
            width: 100%;
            max-height: 200px;
            object-fit: cover;
            border-radius: 8px;
            margin-top: 1rem;
            display: none;
            box-shadow: var(--shadow);
        }

        /* Action Buttons - Mobile Optimized */
        .editor-actions {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border);
            flex-direction: column;
        }

        .btn-action {
            padding: 1rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            width: 100%;
        }

        .btn-draft {
            background: var(--light);
            color: var(--secondary);
            border: 1px solid var(--border);
        }

        .btn-draft:hover {
            background: rgba(0, 0, 0, 0.05);
            transform: translateY(-1px);
            box-shadow: var(--shadow);
        }

        .btn-publish {
            background: var(--secondary);
            color: var(--white);
            box-shadow: var(--shadow);
        }

        .btn-publish:hover {
            background: rgba(0, 0, 0, 0.85);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        /* Preview Modal - Mobile Optimized */
        .preview-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1100;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            padding: 1rem;
        }

        .preview-modal.active {
            opacity: 1;
            visibility: visible;
        }

        .preview-container {
            background: var(--white);
            border-radius: 12px;
            width: 100%;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: var(--shadow-lg);
            transform: translateY(20px);
            transition: transform 0.3s ease;
        }

        .preview-modal.active .preview-container {
            transform: translateY(0);
        }

        .preview-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--light);
        }

        .preview-header h3 {
            margin: 0;
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--secondary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .close-preview {
            background: none;
            border: none;
            font-size: 1.1rem;
            color: var(--gray-medium);
            cursor: pointer;
            transition: color 0.3s ease;
            padding: 0.5rem;
            border-radius: 4px;
        }

        .close-preview:hover {
            color: var(--secondary);
            background: rgba(0, 0, 0, 0.05);
        }

        .preview-body {
            padding: 1.5rem;
            max-height: 70vh;
            overflow-y: auto;
        }

        .preview-content {
            max-width: 100%;
            line-height: 1.6;
        }

        .preview-content h1 {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 1rem;
            color: var(--secondary);
        }

        .preview-content h2 {
            font-size: 1.5rem;
            font-weight: 600;
            margin: 1.5rem 0 0.8rem;
        }

        .preview-content img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin: 1rem 0;
            box-shadow: var(--shadow);
        }

        /* Error Handling */
        .error-message {
            color: #dc3545;
            font-size: 0.85rem;
            margin-top: 0.5rem;
            display: none;
            font-weight: 500;
        }

        .has-error .form-control {
            border-color: #dc3545;
        }

        .has-error .editor-content {
            border-color: #dc3545;
        }

        /* Success Toast */
        .toast-success {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--white);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem 1.5rem;
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            z-index: 1200;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }

        .toast-success.show {
            transform: translateX(0);
        }

        .toast-icon {
            color: #28a745;
            font-size: 1.2rem;
        }

        .toast-message {
            font-weight: 500;
            color: var(--secondary);
        }

        /* Word Count */
        .word-count {
            text-align: right;
            font-size: 0.85rem;
            color: var(--gray-medium);
            margin-top: 0.5rem;
            font-weight: 500;
        }

        /* Desktop Styles */
        @media (min-width: 768px) {
            .mobile-header {
                display: none;
            }

            .desktop-nav {
                display: block;
            }

            .fixed-back-button {
                top: 25px;
                left: 25px;
            }

            .main-container {
                max-width: 900px;
                padding: 2rem 1.5rem;
                padding-top: 2.5rem; /* Added space for fixed back button */
            }

            .editor-header {
                margin-bottom: 2.5rem;
            }

            .editor-title {
                font-size: 2.2rem;
            }

            .editor-subtitle {
                font-size: 1.1rem;
                max-width: 600px;
            }

            .form-group {
                margin-bottom: 2rem;
            }

            .form-control {
                padding: 1rem 1.25rem;
            }

            .editor-toolbar {
                padding: 1rem;
                gap: 0.75rem;
            }

            .toolbar-btn {
                padding: 0.6rem 0.8rem;
                font-size: 0.9rem;
            }

            .editor-content {
                min-height: 400px;
                padding: 2rem;
                font-size: 1.1rem;
                line-height: 1.7;
            }

            .editor-content h1 {
                font-size: 2rem;
                margin: 2rem 0 1rem;
            }

            .editor-content h2 {
                font-size: 1.6rem;
                margin: 1.5rem 0 0.8rem;
            }

            .editor-content h3 {
                font-size: 1.3rem;
                margin: 1.2rem 0 0.6rem;
            }

            .featured-image-section {
                display: flex;
                justify-content: center;
                margin-bottom: 2rem;
            }

            .featured-image-container {
                max-width: 600px;
                width: 100%;
            }

            .image-upload-card {
                padding: 1.5rem;
            }

            .image-upload-container {
                padding: 2.5rem 1.5rem;
            }

            .image-upload-main-icon {
                font-size: 2.5rem;
            }

            .image-preview {
                max-height: 300px;
            }

            .editor-actions {
                flex-direction: row;
                justify-content: center;
                margin-top: 3rem;
                padding-top: 2rem;
            }

            .btn-action {
                width: auto;
                min-width: 160px;
            }

            .preview-container {
                width: 90%;
                max-width: 800px;
            }

            .preview-header {
                padding: 1.5rem 2rem;
            }

            .preview-body {
                padding: 2rem;
            }

            .preview-content h1 {
                font-size: 2.2rem;
            }
        }

        /* Loading state for buttons */
        .btn-action.loading {
            position: relative;
            color: transparent;
        }

        .btn-action.loading::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            top: 50%;
            left: 50%;
            margin-left: -10px;
            margin-top: -10px;
            border: 2px solid transparent;
            border-top-color: currentColor;
            border-radius: 50%;
            animation: button-loading-spinner 0.8s linear infinite;
        }

        @keyframes button-loading-spinner {
            from {
                transform: rotate(0turn);
            }
            to {
                transform: rotate(1turn);
            }
        }
    </style>
</head>
<body>
    <!-- Mobile Header -->
    <div class="mobile-header">
        <h1 class="mobile-title">Create Post</h1>
    </div>

    <!-- Desktop Navigation -->
    <nav class="desktop-nav">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('home_page') }}">
                <i class="fas fa-book-open"></i>
                Readium
            </a>
        </div>
    </nav>

    <!-- Fixed Back Button - Small and Clean -->
    <a href="{{ url_for('home_page') }}" class="fixed-back-button" title="Back to Home">
        <i class="fas fa-arrow-left"></i>
    </a>

    <!-- Main Container -->
    <div class="main-container">
        <div class="editor-header">
            <h1 class="editor-title">Create New Post</h1>
            <p class="editor-subtitle">Share your thoughts, stories, and expertise with the world</p>
        </div>

        <form action="{{ url_for('make_post') }}" method="post" id="postForm" enctype="multipart/form-data">
            <!-- Title Field -->
            <div class="form-group">
                <label for="postTitle" class="form-label">
                    <i class="fas fa-heading"></i>
                    Post Title
                </label>
                <input type="text" class="form-control" id="postTitle" name="title" placeholder="Enter a compelling title for your post" required>
                <div class="error-message" id="titleError">Please enter a title for your post</div>
            </div>

            <!-- Rich Text Editor -->
            <div class="form-group">
                <label class="form-label">
                    <i class="fas fa-edit"></i>
                    Your Story
                </label>
                <div class="editor-wrapper">
                    <div class="editor-toolbar" id="toolbar">
                        <div class="toolbar-group">
                            <button type="button" class="toolbar-btn" data-command="bold" title="Bold">
                                <i class="fas fa-bold"></i>
                            </button>
                            <button type="button" class="toolbar-btn" data-command="italic" title="Italic">
                                <i class="fas fa-italic"></i>
                            </button>
                            <button type="button" class="toolbar-btn" data-command="underline" title="Underline">
                                <i class="fas fa-underline"></i>
                            </button>
                        </div>
                        <div class="toolbar-divider"></div>
                        <div class="toolbar-group">
                            <button type="button" class="toolbar-btn" data-command="insertUnorderedList" title="Bullet List">
                                <i class="fas fa-list-ul"></i>
                            </button>
                            <button type="button" class="toolbar-btn" data-command="insertOrderedList" title="Numbered List">
                                <i class="fas fa-list-ol"></i>
                            </button>
                        </div>
                        <div class="toolbar-divider"></div>
                        <div class="toolbar-group">
                            <button type="button" class="toolbar-btn" data-command="formatBlock" data-value="h1" title="Heading 1">
                                H1
                            </button>
                            <button type="button" class="toolbar-btn" data-command="formatBlock" data-value="h2" title="Heading 2">
                                H2
                            </button>
                            <button type="button" class="toolbar-btn" data-command="formatBlock" data-value="h3" title="Heading 3">
                                H3
                            </button>
                        </div>
                        <div class="toolbar-divider"></div>
                        <div class="toolbar-group">
                            <button type="button" class="toolbar-btn" data-command="createLink" title="Insert Link">
                                <i class="fas fa-link"></i>
                            </button>
                            <button type="button" class="toolbar-btn" data-command="formatBlock" data-value="blockquote" title="Blockquote">
                                <i class="fas fa-quote-right"></i>
                            </button>
                        </div>
                        <div class="toolbar-divider"></div>
                        <div class="toolbar-group">
                            <button type="button" class="toolbar-btn" id="previewBtn" title="Preview Post">
                                <i class="fas fa-eye"></i>
                                Preview
                            </button>
                        </div>
                    </div>
                    <div class="editor-content" id="editor" contenteditable="true" placeholder="Start writing your story here..."></div>
                    <input type="hidden" name="content" id="hiddenContent">
                </div>
                <div class="word-count" id="wordCount">0 words</div>
                <div class="error-message" id="contentError">Please add some content to your post</div>
            </div>

            <!-- Featured Image Section -->
            <div class="featured-image-section">
                <div class="featured-image-container">
                    <div class="image-upload-card">
                        <div class="image-upload-header">
                            <i class="fas fa-image image-upload-icon"></i>
                            <h3 class="image-upload-title">Featured Image</h3>
                        </div>
                        <div class="image-upload-container" id="featuredUploadContainer">
                            <i class="fas fa-cloud-upload-alt image-upload-main-icon"></i>
                            <div class="image-upload-text">Upload Featured Image</div>
                            <div class="image-upload-hint">JPG, PNG or GIF - Max 5MB</div>
                            <img id="featuredPreview" class="image-preview" alt="Featured Preview">
                        </div>
                        <input type="file" name="featured_image" id="featuredInput" accept="image/*" style="display: none;">
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="editor-actions">
                <button type="button" class="btn-action btn-draft" id="saveDraftBtn">
                    <i class="fas fa-save"></i>
                    Save as Draft
                </button>
                <button type="submit" class="btn-action btn-publish" id="publishBtn">
                    <i class="fas fa-paper-plane"></i>
                    Publish Now
                </button>
            </div>
        </form>
    </div>

    <!-- Preview Modal -->
    <div class="preview-modal">
        <div class="preview-container">
            <div class="preview-header">
                <h3><i class="fas fa-eye"></i> Post Preview</h3>
                <button class="close-preview">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="preview-body">
                <div class="preview-content" id="previewContent"></div>
            </div>
        </div>
    </div>

    <!-- Success Toast -->
    <div class="toast-success" id="successToast">
        <i class="fas fa-check-circle toast-icon"></i>
        <div class="toast-message" id="toastMessage">Post saved successfully!</div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const postForm = document.getElementById('postForm');
            const postTitle = document.getElementById('postTitle');
            const editor = document.getElementById('editor');
            const hiddenContent = document.getElementById('hiddenContent');
            const saveDraftBtn = document.getElementById('saveDraftBtn');
            const publishBtn = document.getElementById('publishBtn');
            const titleError = document.getElementById('titleError');
            const contentError = document.getElementById('contentError');
            const wordCount = document.getElementById('wordCount');
            const toolbarButtons = document.querySelectorAll('.toolbar-btn');
            const previewBtn = document.getElementById('previewBtn');
            const previewModal = document.querySelector('.preview-modal');
            const closePreview = document.querySelector('.close-preview');
            const previewContent = document.getElementById('previewContent');
            const successToast = document.getElementById('successToast');
            const toastMessage = document.getElementById('toastMessage');

            // Image upload elements
            const featuredUploadContainer = document.getElementById('featuredUploadContainer');
            const featuredInput = document.getElementById('featuredInput');
            const featuredPreview = document.getElementById('featuredPreview');

            // Set placeholder for contenteditable div
            editor.addEventListener('focus', function() {
                if (this.textContent === 'Start writing your story here...') {
                    this.textContent = '';
                }
            });

            editor.addEventListener('blur', function() {
                if (this.textContent.trim() === '') {
                    this.textContent = 'Start writing your story here...';
                }
            });

            // Word count functionality
            function updateWordCount() {
                const text = editor.textContent.trim();
                const words = text === 'Start writing your story here...' ? 0 : text.split(/\s+/).filter(word => word.length > 0).length;
                wordCount.textContent = `${words} words`;
            }

            editor.addEventListener('input', updateWordCount);

            // Toolbar functionality
            toolbarButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const command = this.dataset.command;
                    const value = this.dataset.value;

                    if (command === 'createLink') {
                        const url = prompt('Enter the URL:');
                        if (url) {
                            document.execCommand(command, false, url);
                        }
                    } else if (value) {
                        document.execCommand(command, false, value);
                    } else {
                        document.execCommand(command, false, null);
                    }

                    // Update active state for format buttons
                    if (command === 'formatBlock') {
                        toolbarButtons.forEach(btn => btn.classList.remove('active'));
                        this.classList.add('active');
                    }

                    // Focus back to editor
                    editor.focus();
                    updateWordCount();
                });
            });

            // Featured image upload
            featuredUploadContainer.addEventListener('click', function() {
                featuredInput.click();
            });

            featuredInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    // Check file size (5MB limit)
                    if (file.size > 5 * 1024 * 1024) {
                        alert('File size must be less than 5MB');
                        return;
                    }

                    const reader = new FileReader();
                    reader.onload = function(e) {
                        featuredPreview.src = e.target.result;
                        featuredPreview.style.display = 'block';
                        featuredUploadContainer.querySelector('.image-upload-text').textContent = 'Change Featured Image';
                    };
                    reader.readAsDataURL(file);
                }
            });

            // Preview functionality
            previewBtn.addEventListener('click', function() {
                const title = postTitle.value || 'Untitled Post';
                const content = editor.innerHTML;
                const featuredImg = featuredPreview.src;

                let previewHTML = `<h1>${title}</h1>`;

                if (featuredImg && featuredPreview.style.display !== 'none') {
                    previewHTML += `<img src="${featuredImg}" alt="Featured Image" style="width: 100%; max-height: 400px; object-fit: cover; border-radius: 8px; margin-bottom: 1.5rem;">`;
                }

                previewHTML += `<div>${content}</div>`;

                previewHTML += `
                    <div style="margin-top: 3rem; padding-top: 1.5rem; border-top: 1px solid var(--border);">
                        <p style="color: var(--gray-medium); font-size: 0.9rem;">
                            Published on ${new Date().toLocaleDateString('en-US', {
                                year: 'numeric',
                                month: 'long',
                                day: 'numeric'
                            })}
                        </p>
                    </div>
                `;

                previewContent.innerHTML = previewHTML;
                previewModal.classList.add('active');
                document.body.style.overflow = 'hidden';
            });

            closePreview.addEventListener('click', function() {
                previewModal.classList.remove('active');
                document.body.style.overflow = 'auto';
            });

            previewModal.addEventListener('click', function(e) {
                if (e.target === previewModal) {
                    previewModal.classList.remove('active');
                    document.body.style.overflow = 'auto';
                }
            });

            // Show toast notification
            function showToast(message) {
                toastMessage.textContent = message;
                successToast.classList.add('show');
                setTimeout(() => {
                    successToast.classList.remove('show');
                }, 3000);
            }

            // Form validation
            function validateForm() {
                let isValid = true;

                // Validate title
                if (!postTitle.value.trim()) {
                    titleError.style.display = 'block';
                    postTitle.parentElement.classList.add('has-error');
                    isValid = false;
                } else {
                    titleError.style.display = 'none';
                    postTitle.parentElement.classList.remove('has-error');
                }

                // Validate content
                const content = editor.textContent.trim();
                if (!content || content === 'Start writing your story here...') {
                    contentError.style.display = 'block';
                    editor.parentElement.classList.add('has-error');
                    isValid = false;
                } else {
                    contentError.style.display = 'none';
                    editor.parentElement.classList.remove('has-error');
                }

                return isValid;
            }

            // CRITICAL FIX: Copy editor content to hidden field
            function prepareFormData() {
                hiddenContent.value = editor.innerHTML;
                console.log('Content prepared for submission');
            }

            // Save as draft
            saveDraftBtn.addEventListener('click', function() {
                if (!validateForm()) return;

                prepareFormData();

                // Show loading state
                this.classList.add('loading');
                this.disabled = true;

                // Simulate API call
                setTimeout(() => {
                    const postData = {
                        title: postTitle.value,
                        content: editor.innerHTML,
                        featuredImage: featuredPreview.src || null,
                        status: 'draft',
                        createdAt: new Date().toISOString(),
                        wordCount: wordCount.textContent
                    };

                    console.log('Saving draft:', postData);

                    // Reset loading state
                    this.classList.remove('loading');
                    this.disabled = false;

                    // Show success message
                    showToast('Draft saved successfully!');
                }, 1500);
            });

            // Publish post
            postForm.addEventListener('submit', function(e) {
                // Always prepare form data first
                prepareFormData();

                if (!validateForm()) {
                    e.preventDefault();
                    return;
                }

                // Show loading state
                publishBtn.classList.add('loading');
                publishBtn.disabled = true;
                saveDraftBtn.disabled = true;

                console.log('Form submitted with content to Flask backend');
            });

            // Initialize
            updateWordCount();
        });
    </script>
</body>
</html>